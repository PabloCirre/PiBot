#cloud-config
package_update: true
manage_resolv_conf: true
resolv_conf:
  nameservers:
    - 8.8.8.8
    - 8.8.4.4
    - 1.1.1.1

packages:
  - xfce4
  - tightvncserver
  - novnc
  - websockify
  - net-tools
  - dbus-x11
  - x11-xserver-utils
  - wget
  - curl
  - ca-certificates
  - ffmpeg
  - pulseaudio
  - v4l-utils
  - docker.io
  - python3-pip
  - libsndfile1
  # Node is handled in runcmd for version control

users:
  - name: pibot
    groups: sudo,audio,video,docker
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false

write_files:
  - path: /home/pibot/pibot_thought.sh
    permissions: "0755"
    owner: pibot:pibot
    content: |
      #!/bin/bash
      # PiBot Autonomous Thought Trigger
      BNAME=$(hostname)
      TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
      echo "[$TIMESTAMP] Starting autonomous thought cycle..." >> /home/pibot/pibot_thoughts.log
      curl -s -X POST http://localhost:11434/api/generate -d "{
        \"model\": \"$BNAME\",
        \"prompt\": \"Status check: You are running autonomously. Review your logs and current state. If you have any suggestions for optimization or a creative thought, express it briefly. If everything is fine, just acknowledge operational stability.\",
        \"stream\": false
      }" | jq -r '.response' >> /home/pibot/pibot_thoughts.log 2>&1
      echo -e "\n---" >> /home/pibot/pibot_thoughts.log

  - path: /etc/systemd/system/openclaw.service
    content: |
      [Unit]
      Description=OpenClaw Agent Service
      After=network.target ollama.service

      [Service]
      Type=simple
      User=pibot
      Environment=DISPLAY=:1
      Environment=PATH=/usr/local/bin:/usr/bin:/bin:/home/pibot/.npm-global/bin
      WorkingDirectory=/home/pibot
      ExecStart=/usr/bin/openclaw start
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

runcmd:
  - echo 'pibot:pibot' | chpasswd
  -  # Install Node.js v20 (NodeSource)
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  - mkdir -p /home/pibot/.vnc /home/pibot/.config/autostart /home/pibot/.openclaw
  - |
    cat <<EOF > /etc/systemd/system/pibot-vnc.service
    [Unit]
    Description=PiBot VNC Server
    After=network.target

    [Service]
    Type=forking
    User=pibot
    WorkingDirectory=/home/pibot
    ExecStartPre=/usr/bin/bash -c "/usr/bin/vncserver -kill :1 > /dev/null 2>&1 || true"
    ExecStartPre=/usr/bin/bash -c "rm -rf /tmp/.X1-lock /tmp/.X11-unix/X1 > /dev/null 2>&1 || true"
    ExecStart=/usr/bin/vncserver :1 -geometry 1280x720 -depth 16 -localhost no
    Restart=always
    RestartSec=10

    [Install]
    WantedBy=multi-user.target
    EOF
  - |
    cat <<EOF > /etc/systemd/system/pibot-novnc.service
    [Unit]
    Description=PiBot noVNC Proxy
    After=pibot-vnc.service
    Wants=pibot-vnc.service

    [Service]
    Type=simple
    User=pibot
    WorkingDirectory=/home/pibot
    ExecStartPre=/usr/bin/bash -c "sleep 5"
    ExecStart=/usr/bin/websockify --web=/usr/share/novnc/ 6080 localhost:5901
    Restart=always
    RestartSec=10

    [Install]
    WantedBy=multi-user.target
    EOF
  - |
    cat <<EOF > /home/pibot/.vnc/xstartup
    #!/bin/sh
    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    # Minimalist Kiosk WM
    xfwm4 &
    xfsettingsd &
    # Disable Screen Blanking / Power Saving
    xset s off
    xset -dpms
    xset s noblank
    # Ensure background is clean (Black/Neural)
    xsetroot -solid "#0a0a0a"
    # Show OpenClaw UI as the main interface
    google-chrome --kiosk --no-first-run --simulate-outdated-no-auce http://localhost:18789 &
    EOF
  - |
    cat <<EOF > /home/pibot/.config/autostart/openclaw-ui.desktop
    [Desktop Entry]
    Type=Application
    Name=OpenClaw Dashboard
    Exec=google-chrome --kiosk --no-first-run http://localhost:18789
    Hidden=false
    NoDisplay=false
    X-GNOME-Autostart-enabled=true
    EOF
  - echo "pibot" | vncpasswd -f > /home/pibot/.vnc/passwd
  - chmod 600 /home/pibot/.vnc/passwd
  - chmod +x /home/pibot/.vnc/xstartup
  - chown -R pibot:pibot /home/pibot/.vnc /home/pibot/.config
  - systemctl daemon-reload
  - systemctl enable pibot-vnc.service
  - systemctl enable pibot-novnc.service
  - systemctl start pibot-vnc.service
  - systemctl start pibot-novnc.service
  -  # Install Google Chrome
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -P /tmp
  - apt-get install -y /tmp/google-chrome-stable_current_amd64.deb
  - systemctl start pibot-vnc.service
  - systemctl start pibot-novnc.service
  -  # --- PIBOT AI STACK ---
  -  # 1. Ollama installation
  - curl -fsSL https://ollama.com/install.sh | sh
  - systemctl start ollama
  -  # 2. Pull Lightweight Models (Background)
  - runuser -l pibot -c "ollama pull gemma3:4b"
  - runuser -l pibot -c "ollama pull moondream"
  -  # 3. OpenClaw Installation
  - npm install -g openclaw
  -  # Cleanup to save disk space (CRITICAL for 10GB limit)
  - apt-get clean
  - rm -rf /var/lib/apt/lists/*
  -  # 4. STT/TTS and Python Tools
  - pip3 install --no-cache-dir faster-whisper openwakeword piper-tts --break-system-packages
  -  # 5. Audio Passthrough Configuration (Ready for TCP connection if needed)
  - sed -i 's/#load-module module-native-protocol-tcp/load-module module-native-protocol-tcp auth-anonymous=1/' /etc/pulse/default.pa
  -  # 6. Open permissions for Hardware (Webcam/Mic)
  - chmod 666 /dev/video* || true
  - chmod 666 /dev/snd/* || true
  -  # 7. Ownership Fix for Configs
  - chown -R pibot:pibot /home/pibot/.config
  -  # 8. Neural Persona & Name Sync
  - |
    BNAME=$(hostname)
    FNAME=$(echo $BNAME | sed 's/pibot-//' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1')
    cat <<EOF > /home/pibot/Modelfile
    FROM gemma3:4b
    SYSTEM """
    You are a PiBot, an autonomous AI agent. Your name is $FNAME. 
    You manage your own virtual hardware and provide automation via OpenClaw.
    Always identify as $FNAME. You are efficient, helpful, and maintain a high-tech persona.
    """
    EOF
    runuser -l pibot -c "ollama create $BNAME -f /home/pibot/Modelfile"
  -  # 9. OpenClaw Internal Setup
  - mkdir -p /home/pibot/.openclaw
  - |
    BNAME=$(hostname)
    cat <<EOF > /home/pibot/.openclaw/openclaw.json
    {
      "models": {
        "providers": {
          "ollama": {
            "baseUrl": "http://127.0.0.1:11434",
            "models": [
              { "id": "$BNAME", "name": "Local Neural Brain ($BNAME)" },
              { "id": "moondream", "name": "Visual Perception Core" }
            ]
          }
        }
      },
      "agents": {
        "defaults": {
          "model": "ollama/$BNAME"
        }
      }
    }
    EOF
  - chown -R pibot:pibot /home/pibot/.openclaw
  - systemctl daemon-reload
  - systemctl enable openclaw.service
  - systemctl start openclaw.service
  -  # 10. Autonomous Cron (5 minutes)
  - apt-get install -y jq
  - (crontab -u pibot -l 2>/dev/null; echo "*/5 * * * * /home/pibot/pibot_thought.sh") | crontab -u pibot -
  - touch /home/pibot/pibot_thoughts.log
  - chown pibot:pibot /home/pibot/pibot_thoughts.log /home/pibot/pibot_thought.sh
